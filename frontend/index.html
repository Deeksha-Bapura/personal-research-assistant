<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Research Assistant</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîç</text></svg>">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [documents, setDocuments] = useState([]);
            const [isUploading, setIsUploading] = useState(false);
            const [showDocuments, setShowDocuments] = useState(false);
            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);

            // Auto-scroll to bottom
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            // Load documents on mount
            useEffect(() => {
                fetchDocuments();
            }, []);

            const fetchDocuments = async () => {
                try {
                    const response = await fetch('http://localhost:5000/api/documents');
                    const data = await response.json();
                    setDocuments(data.documents || []);
                } catch (error) {
                    console.error('Error fetching documents:', error);
                }
            };

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                setIsUploading(true);

                try {
                    const response = await fetch('http://localhost:5000/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert(`Document "${file.name}" uploaded successfully!`);
                        fetchDocuments();
                    } else {
                        alert(`Upload failed: ${data.error}`);
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Upload failed. Please try again.');
                } finally {
                    setIsUploading(false);
                    if (fileInputRef.current) {
                        fileInputRef.current.value = '';
                    }
                }
            };

            const deleteDocument = async (docId) => {
                if (!confirm('Are you sure you want to delete this document?')) return;

                try {
                    const response = await fetch(`http://localhost:5000/api/documents/${docId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        alert('Document deleted successfully!');
                        fetchDocuments();
                    } else {
                        alert('Failed to delete document');
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Failed to delete document');
                }
            };

            const sendMessage = async () => {
                if (!input.trim() || isLoading) return;

                const userMessage = { role: 'user', content: input };
                setMessages(prev => [...prev, userMessage]);
                setInput('');
                setIsLoading(true);

                const assistantMessageIndex = messages.length + 1;
                setMessages(prev => [...prev, { role: 'assistant', content: '' }]);

                try {
                    const response = await fetch('http://localhost:5000/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            messages: messages.concat([userMessage]).map(msg => ({
                                role: msg.role,
                                content: msg.content
                            }))
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`API Error (${response.status}): ${errorData.error?.message || response.statusText}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let accumulatedContent = '';
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6).trim();
                                if (!data || data === '[DONE]') continue;

                                try {
                                    const parsed = JSON.parse(data);
                                    
                                    if (parsed.type === 'content_block_delta' && parsed.delta?.text) {
                                        accumulatedContent += parsed.delta.text;
                                        
                                        setMessages(prev => {
                                            const newMessages = [...prev];
                                            newMessages[assistantMessageIndex] = {
                                                role: 'assistant',
                                                content: accumulatedContent
                                            };
                                            return newMessages;
                                        });
                                    }
                                } catch (e) {
                                    console.warn('Failed to parse SSE data:', data, e);
                                }
                            }
                        }
                    }

                    if (!accumulatedContent) {
                        throw new Error('No response received from the API');
                    }
                } catch (error) {
                    console.error('Full error:', error);
                    setMessages(prev => {
                        const newMessages = [...prev];
                        newMessages[assistantMessageIndex] = {
                            role: 'assistant',
                            content: `‚ùå Error: ${error.message}\n\nPlease check:\n- Backend server is running\n- API key is configured\n- Internet connection is stable`
                        };
                        return newMessages;
                    });
                } finally {
                    setIsLoading(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            const clearChat = () => {
                setMessages([]);
            };

            return (
                <div className="flex h-screen bg-gray-50">
                    {/* Sidebar */}
                    <div className={`${showDocuments ? 'w-80' : 'w-0'} transition-all duration-300 bg-white border-r border-gray-200 overflow-hidden`}>
                        <div className="p-4 border-b border-gray-200">
                            <h2 className="text-lg font-semibold text-gray-800">Documents</h2>
                            <p className="text-sm text-gray-500">{documents.length} uploaded</p>
                        </div>
                        
                        <div className="p-4">
                            <label className="flex items-center justify-center w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 cursor-pointer transition-colors">
                                <span className="text-sm font-medium">
                                    {isUploading ? 'Uploading...' : 'üìÑ Upload Document'}
                                </span>
                                <input
                                    ref={fileInputRef}
                                    type="file"
                                    onChange={handleFileUpload}
                                    accept=".pdf,.docx,.txt,.md"
                                    className="hidden"
                                    disabled={isUploading}
                                />
                            </label>
                            <p className="text-xs text-gray-500 mt-2 text-center">PDF, DOCX, TXT, MD</p>
                        </div>

                        <div className="overflow-y-auto" style={{ height: 'calc(100vh - 200px)' }}>
                            {documents.length === 0 ? (
                                <div className="p-4 text-center text-gray-500">
                                    <p className="text-sm">No documents yet</p>
                                    <p className="text-xs mt-1">Upload to get started!</p>
                                </div>
                            ) : (
                                <div className="space-y-2 p-4">
                                    {documents.map(doc => (
                                        <div key={doc.id} className="bg-gray-50 rounded-lg p-3 hover:bg-gray-100 transition-colors">
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1 min-w-0">
                                                    <p className="text-sm font-medium text-gray-800 truncate">
                                                        {doc.filename}
                                                    </p>
                                                    <p className="text-xs text-gray-500">
                                                        {doc.word_count} words ‚Ä¢ {doc.file_type.toUpperCase()}
                                                    </p>
                                                    <p className="text-xs text-gray-400">
                                                        {new Date(doc.upload_date).toLocaleDateString()}
                                                    </p>
                                                </div>
                                                <button
                                                    onClick={() => deleteDocument(doc.id)}
                                                    className="ml-2 text-red-500 hover:text-red-700 text-sm"
                                                >
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Main Chat Area */}
                    <div className="flex-1 flex flex-col">
                        {/* Header */}
                        <div className="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <button
                                    onClick={() => setShowDocuments(!showDocuments)}
                                    className="px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
                                >
                                    {showDocuments ? '‚óÄ Hide' : 'üìö Documents'}
                                </button>
                                <div>
                                    <h1 className="text-2xl font-bold text-gray-800">Research Assistant</h1>
                                    <p className="text-sm text-gray-500">Powered by Claude ‚Ä¢ {documents.length} documents</p>
                                </div>
                            </div>
                            <button
                                onClick={clearChat}
                                className="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
                            >
                                Clear Chat
                            </button>
                        </div>

                        {/* Messages */}
                        <div className="flex-1 overflow-y-auto px-6 py-6">
                            {messages.length === 0 ? (
                                <div className="flex items-center justify-center h-full">
                                    <div className="text-center">
                                        <div className="text-6xl mb-4">üîç</div>
                                        <h2 className="text-2xl font-semibold text-gray-700 mb-2">Start Your Research</h2>
                                        <p className="text-gray-500 mb-4">Upload documents and ask questions!</p>
                                        <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-3 max-w-2xl mx-auto">
                                            <button
                                                onClick={() => setInput("Explain quantum computing in simple terms")}
                                                className="p-3 text-left bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all"
                                            >
                                                <p className="text-sm font-medium text-gray-700">Explain a concept</p>
                                                <p className="text-xs text-gray-500">Quantum computing basics</p>
                                            </button>
                                            <button
                                                onClick={() => setShowDocuments(true)}
                                                className="p-3 text-left bg-white border border-gray-200 rounded-lg hover:border-blue-300 hover:shadow-sm transition-all"
                                            >
                                                <p className="text-sm font-medium text-gray-700">Upload documents</p>
                                                <p className="text-xs text-gray-500">Build your knowledge base</p>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="max-w-3xl mx-auto space-y-6">
                                    {messages.map((message, index) => (
                                        <div
                                            key={index}
                                            className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}
                                        >
                                            <div
                                                className={`max-w-[80%] rounded-lg px-4 py-3 ${
                                                    message.role === 'user'
                                                        ? 'bg-blue-600 text-white'
                                                        : 'bg-white border border-gray-200 text-gray-800'
                                                }`}
                                            >
                                                <div className="whitespace-pre-wrap break-words">
                                                    {message.content}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    <div ref={messagesEndRef} />
                                </div>
                            )}
                        </div>

                        {/* Input */}
                        <div className="border-t border-gray-200 bg-white px-6 py-4">
                            <div className="max-w-3xl mx-auto">
                                <div className="flex gap-3">
                                    <textarea
                                        value={input}
                                        onChange={(e) => setInput(e.target.value)}
                                        onKeyPress={handleKeyPress}
                                        placeholder="Ask me anything about your research..."
                                        className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                        rows="2"
                                        disabled={isLoading}
                                    />
                                    <button
                                        onClick={sendMessage}
                                        disabled={isLoading || !input.trim()}
                                        className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium disabled:bg-gray-300 disabled:cursor-not-allowed"
                                    >
                                        {isLoading ? '...' : 'Send'}
                                    </button>
                                </div>
                                <p className="text-xs text-gray-500 mt-2">Press Enter to send, Shift+Enter for new line</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>